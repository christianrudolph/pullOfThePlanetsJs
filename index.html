<html>
	<head>
		<title>My first Three.js app</title>
		<style>canvas { width: 100%; height: 100% }</style>
	</head>
	<body>
		<script src="js/three.min.js"></script>
		<script>
			var scene = new THREE.Scene();
			var camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
			camera.position.z = 5;
			var renderer = new THREE.WebGLRenderer();
			renderer.setSize(window.innerWidth, window.innerHeight);
			document.body.appendChild(renderer.domElement);
			
			//var orb1 = new OrbEllipse(scene,5,1,3,2,0);
			var orb2 = new OrbGravitation("sonne",scene,500000000,0,0,0,2,0,0,0);
			var orb3 = new OrbGravitation("erde",scene,500,3,2,0,1,-0.1,0,0);
			this.orbs = new Array();
			this.orbs[0] = orb2;
			this.orbs[1] = orb3;
			var render = function () {
				requestAnimationFrame(render);
				//orb1.moveForward();
				orb2.moveForward(this.orbs);
				orb3.moveForward(this.orbs);
				renderer.render(scene, camera);
			};

			render();
			
			function OrbGravitation (id, scene, mass, x, y, z, radius, vx, vy, vz) {
				var sphereGeometry = new THREE.SphereGeometry(0.1,32,32);
				var sphereMaterial = new THREE.MeshBasicMaterial({color: 0x00ff00});
				this.sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
				scene.add(this.sphere);
				
				this.id=id;
				this.mass = mass;
				this.position = [x,y,z];
				this.radius = radius;
				this.v = [vx,vy,vz];
				
				this.sphere.position.x = x;
				this.sphere.position.y = y;
				this.sphere.position.z = z;
				
				this.lineMaterial = new THREE.LineBasicMaterial({color: 0x0000ff});
				this.lines = new Array();
				this.lineIndex = 0;
			
				OrbGravitation.prototype.moveForward = function(orbs) {
					var gConst = 6.673e-11; //Gravitationskonstante
					var t = 0.4; //time aka. speed
					var oldPosition = [this.position.x,this.position.y,this.position.z];
					
					//Berechnete Werte
					var distance; //Abstand Planet Sonne (Mittelpunkt) 
					var _g; //Fallbeschleunigung komplett
					var gPrev = new Array(); //Fallbeschleunigung als Vektor der vorigen Planeten
					gPrev[0] = gPrev[1] = gPrev[2] = 0; 
					var g = new Array(); //Fallbeschleunigung (als Vektor (x,y,z)) auf Komponenten zerlegt 
					g[0] = g[1] = g[2] = 0; 
					
					for (var i=0;i<orbs.length;i++){
						console.debug("Calculating next position for " + this.id);
						var orb = orbs[i];
						if(this.id != orb.id){ // && orb.isGravitationOrb
							var masseN = orb.mass;
							var posN = orb.position;
							console.debug("position=" + this.position[0] +", "+ this.position[1] +", " + this.position[2]);
							distance = Math.sqrt(Math.pow(this.position[0] - posN[0], 2) + Math.pow(this.position[1] - posN[1], 2) + Math.pow(this.position[2] - posN[2], 2));
							//console.debug("distance=" +distance);
							//Zusammenstoß
							/* if (distance <= (this.radius + orb.radius)) {//Zusammenstoß, Masse wird auf den schwerern Körper übertragen, anderer wird gelöscht
								console.debug("Crash!!");
								if (this.mass <= orb.mass) {
									orb.mass = orb.mass + this.mass;
									this.mass = 0;
									//this.setDelete();
									return;
								}
								else {
									this.mass = orb.mass + this.mass;
									orb = mass = 0;
									//orb.setDelete();
								}
							} */
							_g = -gConst * masseN / (distance * distance);
							// console.debug("_g=" + _g);
							for (var i = 0; i < 3; i++) { // g berechnen 
								g[i] = gPrev[i] + _g * (this.position[i] - posN[i]) / distance;
								gPrev[i] = g[i];
								// g (inkl. Anziehungskräfte vorheriger Planeten (<n)) 

							}
						}
					}
					
					//console.debug("g=[" + g[0] +", "+ g[1] +", " + g[2]+"]");
					for (var i = 0; i < 3; i++) { // v und neue position berechnen 
						this.v[i] = this.v[i] + g[i] * t; // v 
						this.position[i] = this.position[i] + this.v[i] * t + 0,5 * g[i] * t * t; //position 
					}
					console.debug("v=[" + this.v[0] +", "+ this.v[1] +", " + this.v[2]+"]");
					console.debug("New Position:" + this.sphere.position.x +", "+ this.sphere.position.y +", " + this.sphere.position.z);
					
					this.sphere.position.x = this.position[0];
					this.sphere.position.y = this.position[1];
					this.sphere.position.z = this.position[2];
					
					var lineGeometry = new THREE.Geometry();
					lineGeometry.vertices.push( new THREE.Vector3( oldPosition.x, oldPosition.y, oldPosition.z ) );
					lineGeometry.vertices.push( new THREE.Vector3( this.sphere.position.x, this.sphere.position.y, 0 ) );
					this.lines[this.lineIndex] = new THREE.Line( lineGeometry, this.lineMaterial );
					scene.add( this.lines[this.lineIndex]  );
					this.lineIndex = (this.lineIndex + 1) % 500;
					scene.remove(this.lines[this.lineIndex]);
				};
			}
			
			function OrbEllipse (scene, majorAxis, minorAxis, x, y, z) {
				var sphereGeometry = new THREE.SphereGeometry(0.1,32,32);
				var sphereMaterial = new THREE.MeshBasicMaterial({color: 0x00ff00});
				this.sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
				scene.add(this.sphere);
				this.majorAxis = majorAxis;
				this.minorAxis = minorAxis;
				this.angle = 0;
				this.center = [x,y,z]; 
				
				this.lineMaterial = new THREE.LineBasicMaterial({color: 0x0000ff});
				this.lines = new Array();
				this.i = 0;
			
				OrbEllipse.prototype.moveForward = function() {
					var x = this.sphere.position.x;
					var y = this.sphere.position.y;
					var z = this.sphere.position.z;
					this.angle += (Math.PI / 360); //move one degree each iteration
					this.sphere.position.x = this.majorAxis * Math.cos(this.angle) - this.center[0] ;
					this.sphere.position.y = this.minorAxis * Math.sin(this.angle) - this.center[1] ;

					var lineGeometry = new THREE.Geometry();
					lineGeometry.vertices.push( new THREE.Vector3( x, y, z));
					lineGeometry.vertices.push( new THREE.Vector3( this.sphere.position.x, this.sphere.position.y, 0 ) );
					this.lines[this.i] = new THREE.Line( lineGeometry, this.lineMaterial );
					scene.add( this.lines[this.i]  );
					this.i = (this.i + 1) % 500;
					scene.remove(this.lines[this.i]);
				};
			}
		</script>
	</body>
</html>